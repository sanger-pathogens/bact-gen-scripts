#! /usr/bin/env python

##############################################################################
##  DendroPy Phylogenetic Computing Library.
##
##  Copyright 2010 Jeet Sukumaran and Mark T. Holder.
##  All rights reserved.
##
##  See "LICENSE.txt" for terms and conditions of usage.
##
##  If you use this work or any portion thereof in published work,
##  please cite it as:
##
##     Sukumaran, J. and M. T. Holder. 2010. DendroPy: a Python library
##     for phylogenetic computing. Bioinformatics 26: 1569-1571.
##
##############################################################################

"""
BEAST data read/write parse/format tests.
"""

import sys
import os
import unittest
import tempfile
from cStringIO import StringIO

from dendropy.test.support import pathmap
from dendropy.test.support import datagen
from dendropy.test.support import datatest
from dendropy.test.support import extendedtest
from dendropy import dataio
from dendropy.utility import error
from dendropy.utility.messaging import get_logger
import dendropy
from dendropy.dataio.beast import BEAST_SUMMARY_TREE_NODE_FIELDS

_LOG = get_logger(__name__)

REFERENCE_SPLIT_NODE_INFO_MAP = {
    8589934591: {
        'height': 140.034449011,
        'height_median': 138.844324064,
        'height_95hpd': [96.08130962980002, 188.13285870459998],
        'height_range': [74.3872519715, 239.3934470149],
        'length': 0.0,
        'length_median': None,
        'length_95hpd': None,
        'length_range': None,
        'posterior': 1.0,
        },
    4294967295: {
        'height': 105.764341326,
        'height_median': 104.661907392,
        'height_95hpd': [74.25594034370002, 139.5716113857],
        'height_range': [55.89152897150001, 184.45990461039997],
        'length': 34.5403182618,
        'length_median': 33.2835685,
        'length_95hpd': [7.812277, 62.805006],
        'length_range': [0.146351, 98.24161],
        'posterior': 0.989388264669,
        },
    2147483647: {
        'height': 89.576751374,
        'height_median': 88.8554251966,
        'height_95hpd': [62.59552718989999, 117.82147203350002],
        'height_range': [44.895928971500005, 151.7435918009],
        'length': 16.9243613169,
        'length_median': 15.999222,
        'length_95hpd': [3.770579, 31.944904],
        'length_range': [0.018699, 67.272426],
        'posterior': 0.74063670412,
        },
    1: {
        'height': 9.36738514878e-07,
        'height_median': 8.69649994684e-07,
        'height_95hpd': [0.0, 1.93750000221371e-06],
        'height_range': [0.0, 3.521400032013844e-06],
        'length': 92.8402897306,
        'length_median': 91.6013102116,
        'length_95hpd': [64.4575883559, 128.125579472],
        'length_range': [44.8959287917, 172.396026532],
        'posterior': None,
        },
    2147483646: {
        'height': 60.4241558355,
        'height_median': 60.1016009558,
        'height_95hpd': [43.48883224400001, 77.94902433529998],
        'height_range': [31.464813971500007, 97.8517348009],
        'length': 30.4270466439,
        'length_median': 29.7244475,
        'length_95hpd': [14.633973, 45.445798],
        'length_range': [11.375035, 74.979955],
        'posterior': 1.0,
        },
    134217726: {
        'height': 51.1223249298,
        'height_median': 50.8235091372,
        'height_95hpd': [36.469876846600016, 65.9969224486],
        'height_range': [28.421823971500004, 84.42355280090001],
        'length': 9.30183090574,
        'length_median': 9.0387525,
        'length_95hpd': [4.203416, 14.768358],
        'length_range': [2.378519, 23.5722],
        'posterior': 1.0,
        },
    33554430: {
        'height': 40.4831052116,
        'height_median': 40.2406407279,
        'height_95hpd': [28.651056040000014, 51.4320705091],
        'height_range': [21.706709971500004, 65.8981248009],
        'length': 10.6392197182,
        'length_median': 10.424531,
        'length_95hpd': [5.381388, 15.795307],
        'length_range': [3.713739, 21.846265],
        'posterior': 1.0,
        },
    1022: {
        'height': 38.3763910122,
        'height_median': 38.1809237072,
        'height_95hpd': [27.973391349799982, 49.9579948068],
        'height_range': [22.803103902399997, 64.2018678009],
        'length': 1.97571218131,
        'length_median': 1.788666,
        'length_95hpd': [0.139025, 4.227935],
        'length_range': [0.009372, 7.600051],
        'posterior': 0.831460674157,
        },
    2: {
        'height': 9.30188171303e-07,
        'height_median': 9.06650001298e-07,
        'height_95hpd': [0.0, 1.6579000430283486e-06],
        'height_range': [0.0, 2.7469999679397006e-06],
        'length': 38.5573371675,
        'length_median': 38.313274909,
        'length_95hpd': [27.5982908755, 49.9773260243],
        'length_range': [21.056432096, 64.2018660606],
        'posterior': None,
        },
    1020: {
        'height': 36.935369804,
        'height_median': 36.6779349072,
        'height_95hpd': [26.971595640499984, 48.186893898200026],
        'height_range': [20.018198971500006, 62.4160098009],
        'length': 1.94095750142,
        'length_median': 1.7881385,
        'length_95hpd': [0.223259, 4.079754],
        'length_range': [0.000938, 6.893546],
        'posterior': 0.880149812734,
        },
    252: {
        'height': 33.4003968814,
        'height_median': 33.1579868399,
        'height_95hpd': [24.37434634979998, 43.74003936849999],
        'height_range': [17.596163971500005, 54.887102800899996],
        'length': 3.68443438688,
        'length_median': 3.4942755,
        'length_95hpd': [0.819195, 6.830918],
        'length_range': [0.081245, 10.640105],
        'posterior': 0.913233458177,
        },
    60: {
        'height': 27.2909353605,
        'height_median': 27.0194416769,
        'height_95hpd': [18.845875338100015, 35.6373419894],
        'height_range': [13.739952971500003, 47.4277218009],
        'length': 6.33635164856,
        'length_median': 6.11195,
        'length_95hpd': [2.636092, 10.204425],
        'length_range': [1.312515, 15.419099],
        'posterior': 1.0,
        },
    12: {
        'height': 6.82390321008,
        'height_median': 6.7061693231,
        'height_95hpd': [4.155358528799994, 9.535295108500009],
        'height_range': [3.0302601152999955, 12.926974564900007],
        'length': 18.9272522909,
        'length_median': 18.711787,
        'length_95hpd': [11.373818, 25.954112],
        'length_range': [7.839346, 35.302593],
        'posterior': 1.0,
        },
    4: {
        'height': 9.51340106579e-07,
        'height_median': 8.78999991016e-07,
        'height_95hpd': [0.0, 2.12929998610889e-06],
        'height_range': [0.0, 3.87429994930244e-06],
        'length': 6.82390225874,
        'length_median': 6.70616855745,
        'length_95hpd': [4.1553567059, 9.5352941986],
        'length_range': [3.0302599028, 12.9269739584],
        'posterior': None,
        },
    8: {
        'height': 9.51340106579e-07,
        'height_median': 8.78999991016e-07,
        'height_95hpd': [0.0, 2.12929998610889e-06],
        'height_range': [0.0, 3.87429994930244e-06],
        'length': 6.82390225874,
        'length_median': 6.70616855745,
        'length_95hpd': [4.1553567059, 9.5352941986],
        'length_range': [3.0302599028, 12.9269739584],
        'posterior': None,
        },
    48: {
        'height': 22.293347602,
        'height_median': 22.1750581078,
        'height_95hpd': [14.858060836299984, 29.823690485000043],
        'height_range': [11.4281999715, 38.12343574160002],
        'length': 4.75672958821,
        'length_median': 4.586898,
        'length_95hpd': [1.678908, 8.160487],
        'length_range': [0.311152, 14.045883],
        'posterior': 0.672284644195,
        },
    16: {
        'height': 9.42665730734e-07,
        'height_median': 8.69399997327e-07,
        'height_95hpd': [0.0, 2.1092000395128707e-06],
        'height_range': [0.0, 3.5751000382333586e-06],
        'length': 22.5565173476,
        'length_median': 22.3545992793,
        'length_95hpd': [15.123040004, 30.1008667813],
        'length_range': [11.4281997831, 38.1234342572],
        'posterior': None,
        },
    32: {
        'height': 9.41221816895e-07,
        'height_median': 8.74149989727e-07,
        'height_95hpd': [0.0, 2.0738000046094385e-06],
        'height_range': [0.0, 3.5751000382333586e-06],
        'length': 24.0898191125,
        'length_median': 23.6902445325,
        'length_95hpd': [15.0933363534, 33.555026279],
        'length_range': [11.4281997831, 42.0837216212],
        'posterior': None,
        },
    192: {
        'height': 14.2740536976,
        'height_median': 14.1700778858,
        'height_95hpd': [9.388850490900012, 19.572088065200035],
        'height_range': [6.381452620599987, 27.5238039578],
        'length': 19.1689417871,
        'length_median': 18.9435995,
        'length_95hpd': [12.071658, 25.926247],
        'length_range': [9.052914, 34.87535],
        'posterior': 1.0,
        },
    64: {
        'height': 9.47364013976e-07,
        'height_median': 9.05199989631e-07,
        'height_95hpd': [0.0, 1.9837000024836016e-06],
        'height_range': [0.0, 3.5473999560053926e-06],
        'length': 14.2740527502,
        'length_median': 14.1700775888,
        'length_95hpd': [9.3888496992, 19.572087082],
        'length_range': [6.3814511658, 27.5238034895],
        'posterior': None,
        },
    128: {
        'height': 9.47364013976e-07,
        'height_median': 9.05199989631e-07,
        'height_95hpd': [0.0, 1.9837000024836016e-06],
        'height_range': [0.0, 3.5473999560053926e-06],
        'length': 14.2740527502,
        'length_median': 14.1700775888,
        'length_95hpd': [9.3888496992, 19.572087082],
        'length_range': [6.3814511658, 27.5238034895],
        'posterior': None,
        },
    768: {
        'height': 22.2156349935,
        'height_median': 22.0465275958,
        'height_95hpd': [14.9576099959, 29.764161910699983],
        'height_range': [12.041834902399998, 43.059845610400004],
        'length': 14.5586521614,
        'length_median': 14.225256,
        'length_95hpd': [9.070399, 21.131312],
        'length_range': [4.557353, 30.069047],
        'posterior': 1.0,
        },
    256: {
        'height': 9.38303870463e-07,
        'height_median': 9.26150015346e-07,
        'height_95hpd': [0.0, 1.8967000130487577e-06],
        'height_range': [0.0, 3.158499993105579e-06],
        'length': 22.2156340552,
        'length_median': 22.0465265573,
        'length_95hpd': [14.9576099959, 29.7641608137],
        'length_range': [12.0418334406, 43.0598450217],
        'posterior': None,
        },
    512: {
        'height': 9.38303870463e-07,
        'height_median': 9.26150015346e-07,
        'height_95hpd': [0.0, 1.8967000130487577e-06],
        'height_range': [0.0, 3.158499993105579e-06],
        'length': 22.2156340552,
        'length_median': 22.0465265573,
        'length_95hpd': [14.9576099959, 29.7641608137],
        'length_range': [12.0418334406, 43.0598450217],
        'posterior': None,
        },
    33553408: {
        'height': 37.7227055006,
        'height_median': 37.4719362208,
        'height_95hpd': [27.290156640499987, 48.008353642],
        'height_range': [20.3243949715, 63.884425800900004],
        'length': 2.61659578937,
        'length_median': 2.486825,
        'length_95hpd': [0.633375, 4.720052],
        'length_range': [0.252995, 9.436347],
        'posterior': 0.992821473159,
        },
    261120: {
        'height': 24.2584420063,
        'height_median': 24.2299659379,
        'height_95hpd': [18.302492457300005, 30.3917045675],
        'height_range': [14.001768971499999, 35.06016533900001],
        'length': 13.453264559,
        'length_median': 13.1326975,
        'length_95hpd': [7.636753, 19.326242],
        'length_range': [4.260203, 30.57334],
        'posterior': 1.0,
        },
    3072: {
        'height': 10.8781664364,
        'height_median': 10.7613225949,
        'height_95hpd': [6.974406073599994, 14.715661009200005],
        'height_range': [4.8406909714999955, 19.00244479289998],
        'length': 12.9696990175,
        'length_median': 12.880898,
        'length_95hpd': [8.74993, 17.40318],
        'length_range': [6.678049, 22.157308],
        'posterior': 1.0,
        },
    1024: {
        'height': 9.2565845855e-07,
        'height_median': 9.04200000207e-07,
        'height_95hpd': [0.0, 1.844199999823104e-06],
        'height_range': [0.0, 2.892000026122332e-06],
        'length': 10.8781655107,
        'length_median': 10.7613212391,
        'length_95hpd': [6.9744053413, 14.7156598291],
        'length_range': [4.840690275, 19.0024446216],
        'posterior': None,
        },
    2048: {
        'height': 9.2565845855e-07,
        'height_median': 9.04200000207e-07,
        'height_95hpd': [0.0, 1.844199999823104e-06],
        'height_range': [0.0, 2.892000026122332e-06],
        'length': 10.8781655107,
        'length_median': 10.7613212391,
        'length_95hpd': [6.9744053413, 14.7156598291],
        'length_range': [4.840690275, 19.0024446216],
        'posterior': None,
        },
    258048: {
        'height': 22.6008526247,
        'height_median': 22.626147126,
        'height_95hpd': [16.46090290880001, 28.18573695639998],
        'height_range': [13.194231691499994, 32.869519251900016],
        'length': 1.60210719178,
        'length_median': 1.4663975,
        'length_95hpd': [0.03165, 3.369255],
        'length_range': [0.01467, 7.879538],
        'posterior': 0.683520599251,
        },
    126976: {
        'height': 13.9827075703,
        'height_median': 13.8634112042,
        'height_95hpd': [9.525066727700008, 18.94650987009996],
        'height_range': [7.1022519343, 25.272972339000006],
        'length': 8.7989215515,
        'length_median': 8.6555065,
        'length_95hpd': [5.001629, 13.021937],
        'length_range': [3.074453, 17.477306],
        'posterior': 1.0,
        },
    61440: {
        'height': 10.5476625714,
        'height_median': 10.438272179,
        'height_95hpd': [6.614036884000015, 14.473356963799972],
        'height_range': [4.684223193299999, 17.65485500919999],
        'length': 3.44787036212,
        'length_median': 3.314387,
        'length_95hpd': [0.662309, 6.710392],
        'length_range': [0.007844, 10.515651],
        'posterior': 0.972222222222,
        },
    4096: {
        'height': 9.38684144925e-07,
        'height_median': 8.57899991047e-07,
        'height_95hpd': [0.0, 2.01040001002184e-06],
        'height_range': [0.0, 3.279200001315985e-06],
        'length': 10.6232166032,
        'length_median': 10.4800826871,
        'length_95hpd': [6.6371281239, 14.6817334744],
        'length_range': [4.6842224586, 19.1373188465],
        'posterior': None,
        },
    57344: {
        'height': 4.07961608212,
        'height_median': 3.98160629095,
        'height_95hpd': [2.023828001499993, 6.138489526000001],
        'height_range': [1.6685757375000065, 8.490266406899963],
        'length': 6.51899534894,
        'length_median': 6.354094,
        'length_95hpd': [3.514423, 10.254355],
        'length_range': [2.120429, 13.998063],
        'posterior': 1.0,
        },
    8192: {
        'height': 9.33952153603e-07,
        'height_median': 8.32349989821e-07,
        'height_95hpd': [0.0, 2.1562000256380998e-06],
        'height_range': [0.0, 3.4575000142922363e-06],
        'length': 3.72951693437,
        'length_median': 3.63603542925,
        'length_95hpd': [1.7283794641, 5.9808752455],
        'length_range': [0.8296878757, 8.2851849995],
        'posterior': None,
        },
    49152: {
        'height': 2.94650397871,
        'height_median': 2.86526067545,
        'height_95hpd': [1.4329980593999778, 4.783792209299975],
        'height_range': [0.8399478944999856, 6.269506386699987],
        'length': 1.14473876532,
        'length_median': 1.019842,
        'length_95hpd': [0.046886, 2.502542],
        'length_range': [0.001353, 5.112696],
        'posterior': 0.6822721598,
        },
    16384: {
        'height': 9.36328839093e-07,
        'height_median': 8.50250010842e-07,
        'height_95hpd': [0.0, 2.2380999951110425e-06],
        'height_range': [0.0, 3.5393000104022576e-06],
        'length': 2.95525322943,
        'length_median': 2.8566659138,
        'length_95hpd': [1.4152943296, 4.7869677878],
        'length_range': [0.8296878757, 6.6817945054],
        'posterior': None,
        },
    32768: {
        'height': 9.41938140135e-07,
        'height_median': 8.54850000565e-07,
        'height_95hpd': [0.0, 2.2125000072037437e-06],
        'height_range': [0.0, 3.5393000104022576e-06],
        'length': 3.29183206309,
        'length_median': 3.13421220505,
        'length_95hpd': [1.4418566668, 5.4638419212],
        'length_range': [0.8399470332, 8.4902640479],
        'posterior': None,
        },
    65536: {
        'height': 9.32785237606e-07,
        'height_median': 8.71499992172e-07,
        'height_95hpd': [0.0, 1.9267999959993176e-06],
        'height_range': [0.0, 3.3000999621890514e-06],
        'length': 13.9433128407,
        'length_median': 13.8194888466,
        'length_95hpd': [9.3815710283, 18.904489752],
        'length_range': [7.1022506217, 25.272972339],
        'posterior': None,
        },
    131072: {
        'height': 9.2991008118e-07,
        'height_median': 8.91850007179e-07,
        'height_95hpd': [0.0, 1.7860000127711828e-06],
        'height_range': [0.0, 3.1539000246993965e-06],
        'length': 23.1345308729,
        'length_median': 23.1348188126,
        'length_95hpd': [17.0853057262, 29.1415747578],
        'length_range': [13.1942299723, 35.0601650979],
        'posterior': None,
        },
    33292288: {
        'height': 32.5338475543,
        'height_median': 32.2499131968,
        'height_95hpd': [23.147799468300008, 41.7313108347],
        'height_range': [16.4713679715, 54.01826576419998],
        'length': 5.18662319164,
        'length_median': 5.050274,
        'length_95hpd': [2.461245, 8.234722],
        'length_range': [0.70572, 14.383835],
        'posterior': 1.0,
        },
    1835008: {
        'height': 26.913117715,
        'height_median': 26.6370381847,
        'height_95hpd': [18.8462976915, 35.460985958999984],
        'height_range': [13.389836971500003, 44.622195800900016],
        'length': 5.61983364877,
        'length_median': 5.421898,
        'length_95hpd': [2.407503, 9.418195],
        'length_range': [1.194589, 13.683196],
        'posterior': 0.999687890137,
        },
    262144: {
        'height': 9.45493040613e-07,
        'height_median': 8.97450007642e-07,
        'height_95hpd': [0.0, 1.853300005905112e-06],
        'height_range': [0.0, 3.2254999950964702e-06],
        'length': 26.9157669656,
        'length_median': 26.638382673,
        'length_95hpd': [18.8462965185, 35.4609849664],
        'length_range': [13.389835692, 44.6221957577],
        'posterior': None,
        },
    1572864: {
        'height': 16.1878814233,
        'height_median': 15.9738624461,
        'height_95hpd': [10.987778061900002, 21.87690016229999],
        'height_range': [7.1595999715000005, 28.163446800900005],
        'length': 10.727688573,
        'length_median': 10.489054,
        'length_95hpd': [5.788115, 15.369166],
        'length_range': [3.440848, 23.59948],
        'posterior': 1.0,
        },
    524288: {
        'height': 9.44095131542e-07,
        'height_median': 9.10000004239e-07,
        'height_95hpd': [0.0, 1.975999964543007e-06],
        'height_range': [0.0, 3.4905999939383037e-06],
        'length': 16.1878804792,
        'length_median': 15.9738608475,
        'length_95hpd': [10.9877776774, 21.8769001623],
        'length_range': [7.1595991434, 28.1634468009],
        'posterior': None,
        },
    1048576: {
        'height': 9.44095131542e-07,
        'height_median': 9.10000004239e-07,
        'height_95hpd': [0.0, 1.975999964543007e-06],
        'height_range': [0.0, 3.4905999939383037e-06],
        'length': 16.1878804792,
        'length_median': 15.9738608475,
        'length_95hpd': [10.9877776774, 21.8769001623],
        'length_range': [7.1595991434, 28.1634468009],
        'posterior': None,
        },
    31457280: {
        'height': 27.5346204595,
        'height_median': 27.3151453937,
        'height_95hpd': [19.873705233699994, 36.14962195839999],
        'height_range': [14.6751719715, 42.561733513399986],
        'length': 4.99902918009,
        'length_median': 4.848443,
        'length_95hpd': [1.970773, 8.113197],
        'length_range': [1.054565, 15.401584],
        'posterior': 1.0,
        },
    2097152: {
        'height': 9.33268352364e-07,
        'height_median': 8.8304999224e-07,
        'height_95hpd': [0.0, 1.8297999986316427e-06],
        'height_range': [0.0, 3.1756999590015766e-06],
        'length': 27.5346195262,
        'length_median': 27.3151445415,
        'length_95hpd': [19.8737046293, 36.1496210779],
        'length_range': [14.6751713598, 42.5617319848],
        'posterior': None,
        },
    29360128: {
        'height': 22.8679121202,
        'height_median': 22.6534863058,
        'height_95hpd': [16.14230478169999, 30.63820872970001],
        'height_range': [10.760313650100002, 36.714165339000004],
        'length': 4.66670833926,
        'length_median': 4.508922,
        'length_95hpd': [1.897255, 7.623389],
        'length_range': [1.173056, 10.991166],
        'posterior': 1.0,
        },
    12582912: {
        'height': 7.9337710456,
        'height_median': 7.825060697,
        'height_95hpd': [4.850802398699997, 11.014451514099989],
        'height_range': [3.5694106500999965, 16.123624619799955],
        'length': 14.9341410746,
        'length_median': 14.7437695,
        'length_95hpd': [9.713509, 20.751153],
        'length_range': [6.882947, 26.005194],
        'posterior': 1.0,
        },
    4194304: {
        'height': 9.491898877e-07,
        'height_median': 8.99600024695e-07,
        'height_95hpd': [0.0, 2.0907000077841076e-06],
        'height_range': [0.0, 3.762099964887966e-06],
        'length': 7.93377009641,
        'length_median': 7.82505898955,
        'length_95hpd': [4.8508012656, 11.0144515141],
        'length_range': [3.569409682, 16.1236232745],
        'posterior': None,
        },
    8388608: {
        'height': 9.491898877e-07,
        'height_median': 8.99600024695e-07,
        'height_95hpd': [0.0, 2.0907000077841076e-06],
        'height_range': [0.0, 3.762099964887966e-06],
        'length': 7.93377009641,
        'length_median': 7.82505898955,
        'length_95hpd': [4.8508012656, 11.0144515141],
        'length_range': [3.569409682, 16.1236232745],
        'posterior': None,
        },
    16777216: {
        'height': 9.43284925435e-07,
        'height_median': 8.89149987415e-07,
        'height_95hpd': [0.0, 1.999000005525886e-06],
        'height_range': [0.0, 3.6301999841725774e-06],
        'length': 22.8679111769,
        'length_median': 22.6534853781,
        'length_95hpd': [16.1423038774, 30.6382076744],
        'length_range': [10.7603128534, 36.7141641935],
        'posterior': None,
        },
    100663296: {
        'height': 26.0546972191,
        'height_median': 25.7981574147,
        'height_95hpd': [16.92592671070001, 35.07400466679999],
        'height_range': [13.09496812419998, 50.472772617900034],
        'length': 25.0676277107,
        'length_median': 24.82948,
        'length_95hpd': [16.345766, 34.498308],
        'length_range': [12.214308, 48.358021],
        'posterior': 1.0,
        },
    33554432: {
        'height': 9.40253808223e-07,
        'height_median': 9.18800012073e-07,
        'height_95hpd': [0.0, 1.827199994863804e-06],
        'height_range': [0.0, 3.4932999710690638e-06],
        'length': 26.0546962789,
        'length_median': 25.7981564491,
        'length_95hpd': [16.9259254797, 35.0740036122],
        'length_range': [13.094967405, 50.4727716963],
        'posterior': None,
        },
    67108864: {
        'height': 9.40253808223e-07,
        'height_median': 9.18800012073e-07,
        'height_95hpd': [0.0, 1.827199994863804e-06],
        'height_range': [0.0, 3.4932999710690638e-06],
        'length': 26.0546962789,
        'length_median': 25.7981564491,
        'length_95hpd': [16.9259254797, 35.0740036122],
        'length_range': [13.094967405, 50.4727716963],
        'posterior': None,
        },
    2013265920: {
        'height': 42.3025605843,
        'height_median': 41.8526575201,
        'height_95hpd': [28.065664995899994, 54.73444218319999],
        'height_range': [22.429587971500005, 72.73628880090001],
        'length': 18.1215952512,
        'length_median': 17.7953005,
        'length_95hpd': [10.190512, 26.35219],
        'length_range': [6.716564, 41.535438],
        'posterior': 1.0,
        },
    939524096: {
        'height': 34.6738082732,
        'height_median': 34.3405733661,
        'height_95hpd': [23.63529365929999, 45.87588644179999],
        'height_range': [19.307032183800004, 61.44261280090001],
        'length': 7.63635483911,
        'length_median': 7.304269,
        'length_95hpd': [2.492501, 12.971774],
        'length_range': [0.862086, 21.630931],
        'posterior': 0.999063670412,
        },
    134217728: {
        'height': 9.38333208706e-07,
        'height_median': 8.66949982026e-07,
        'height_95hpd': [0.0, 1.995500014118079e-06],
        'height_range': [0.0, 3.6089000161609874e-06],
        'length': 34.6733549518,
        'length_median': 34.3424085474,
        'length_95hpd': [23.6352921335, 45.8758852566],
        'length_range': [19.3070310252, 61.4426113272],
        'posterior': None,
        },
    805306368: {
        'height': 21.5580877772,
        'height_median': 21.2013098308,
        'height_95hpd': [14.28244597150001, 29.672228262899978],
        'height_range': [11.180701829699998, 41.04016580090001],
        'length': 13.1098164501,
        'length_median': 12.8566475,
        'length_95hpd': [6.49073, 19.866972],
        'length_range': [3.691371, 35.749473],
        'posterior': 1.0,
        },
    268435456: {
        'height': 9.41299531965e-07,
        'height_median': 8.8539998444e-07,
        'height_95hpd': [0.0, 2.1033000194847773e-06],
        'height_range': [0.0, 3.5737000132485264e-06],
        'length': 21.5580868359,
        'length_median': 21.2013085647,
        'length_95hpd': [14.2824456805, 29.6722278425],
        'length_range': [11.1807014734, 41.0401639363],
        'posterior': None,
        },
    536870912: {
        'height': 9.41299531965e-07,
        'height_median': 8.8539998444e-07,
        'height_95hpd': [0.0, 2.1033000194847773e-06],
        'height_range': [0.0, 3.5737000132485264e-06],
        'length': 21.5580868359,
        'length_median': 21.2013085647,
        'length_95hpd': [14.2824456805, 29.6722278425],
        'length_range': [11.1807014734, 41.0401639363],
        'posterior': None,
        },
    1073741824: {
        'height': 9.39846660719e-07,
        'height_median': 8.77250016629e-07,
        'height_95hpd': [0.0, 1.9382999880690477e-06],
        'height_range': [0.0, 3.213699983461993e-06],
        'length': 42.2971079815,
        'length_median': 41.8526564966,
        'length_95hpd': [28.0546069186, 54.7344415945],
        'length_range': [22.4295876473, 72.7362873468],
        'posterior': None,
        },
    2147483648: {
        'height': 9.33298065372e-07,
        'height_median': 8.78999998122e-07,
        'height_95hpd': [0.0, 1.979100034077419e-06],
        'height_range': [0.0, 3.1946000262905727e-06],
        'length': 102.944573158,
        'length_median': 101.809056216,
        'length_95hpd': [69.2007084654, 137.3664601435],
        'length_range': [51.5305760058, 184.4599043439],
        'posterior': None,
        },
    4294967296: {
        'height': 9.34599875499e-07,
        'height_median': 8.75950000534e-07,
        'height_95hpd': [0.0, 2.113599975928082e-06],
        'height_range': [0.0, 3.763500046716217e-06],
        'length': 139.966397733,
        'length_median': 138.778814678,
        'length_95hpd': [96.0510095689, 188.4028103651],
        'length_range': [60.2179037043, 239.393446406],
        'posterior': None,
        },
}

class BeastSummaryTreeTests(datatest.AnnotatedDataObjectVerificationTestCase):

    def verify_node_info(self, tree):
        tree.update_splits()
        for edge in tree.postorder_edge_iter():
            node = edge.head_node
            ref_node_info = REFERENCE_SPLIT_NODE_INFO_MAP[edge.split_bitmask]
            for field, ref_val in ref_node_info.items():
                self.assertTrue(hasattr(node, field))
                node_val = getattr(node, field)
                if ref_val is None:
                    self.assertIs(getattr(node, field, -1), None)
                elif isinstance(ref_val, list):
                    self.assertEqual(len(ref_val), len(node_val))
                    for idx, ref_val_i in enumerate(ref_val):
                        self.assertAlmostEqual(ref_val[idx], node_val[idx])
                else:
                    self.assertAlmostEqual(ref_val, node_val)

    def testReadSummaryTree(self):
        tree = dendropy.Tree.get_from_stream(pathmap.tree_source_stream('pythonidae.beast.summary.tre'), 'beast-summary-tree')
        self.verify_node_info(tree)
        #for nd in tree:
        #    print('%s: {' % nd.edge.split_bitmask)
        #    for field in BEAST_SUMMARY_TREE_NODE_FIELDS:
        #        print("    '%s': %s," % (field, str(getattr(nd, field))))
        #    print("    },")

    def testSummaryTreeIter(self):
        stream = pathmap.tree_source_stream('pythonidae.beast.summary.tre')
        for tree in dendropy.tree_source_iter(stream, 'beast-summary-tree'):
            self.verify_node_info(tree)

if __name__ == "__main__":
    unittest.main()

